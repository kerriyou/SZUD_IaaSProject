name: Auto-Build Windows Release - Dual Compiler

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Preuzmi kod
      uses: actions/checkout@v4

    - name: Kompajliraj sa MinGW
      run: |
        g++ main.cpp -o IaasSimulator-mingw.exe -static -static-libgcc -static-libstdc++ -std=c++17 -O2
      shell: bash

    - name: Kompajliraj sa MSVC
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cl /EHsc /std:c++17 /O2 /Fe:IaasSimulator-msvc.exe main.cpp
      shell: cmd

    - name: Kreiraj README
      run: |
        @echo # IaaS Simulator - Windows Build > README-release.txt
        @echo. >> README-release.txt
        @echo ## Dostupne verzije: >> README-release.txt
        @echo. >> README-release.txt
        @echo ### 1. IaasSimulator-mingw.exe >> README-release.txt
        @echo - Kompajler: MinGW/G++ (statiÄki linkovano) >> README-release.txt
        @echo - Zavisnosti: NEMA - radi svuda >> README-release.txt
        @echo. >> README-release.txt
        @echo ### 2. IaasSimulator-msvc.exe >> README-release.txt
        @echo - Kompajler: Microsoft Visual C++ >> README-release.txt
        @echo - Zavisnosti: VC++ Redistributable >> README-release.txt
      shell: cmd

    - name: Postavi tag
      id: set_tag
      run: echo "RELEASE_TAG=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      shell: bash

    - name: Kreiraj Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.set_tag.outputs.RELEASE_TAG }}
        name: IaaS Simulator ${{ steps.set_tag.outputs.RELEASE_TAG }}
        body: |
          Dual-compiler Windows build
          
          **MinGW version**: No dependencies (static linking)
          **MSVC version**: Requires VC++ Redistributable
        files: |
          IaasSimulator-mingw.exe
          IaasSimulator-msvc.exe
          README-release.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
